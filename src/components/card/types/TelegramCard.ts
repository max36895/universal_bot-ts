import { TemplateCardTypes } from './TemplateCardTypes';
import { TelegramRequest } from '../../../api/TelegramRequest';
import { ImageTokens } from '../../../models/ImageTokens';
import { TTelegramChatId } from '../../../api';

/**
 * @interface ITelegramCard
 * –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ.
 * –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –æ–ø—Ä–æ—Å —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤.
 *
 * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
 * - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
 * - –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ –∫–Ω–æ–ø–∫–∏
 * - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ä–æ—Å–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
 * - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã–µ –∏ –ø—É–±–ª–∏—á–Ω—ã–µ –æ–ø—Ä–æ—Å—ã
 *
 * @example
 * ```typescript
 * // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –æ–ø—Ä–æ—Å–∞
 * const card: ITelegramCard = {
 *     question: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞',
 *     options: ['–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', '–û–¥–µ–∂–¥–∞', '–ö–Ω–∏–≥–∏']
 * };
 *
 * // –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞ —Å —ç–º–æ–¥–∑–∏
 * const cardWithEmoji: ITelegramCard = {
 *     question: '–ö–∞–∫–æ–π —Ç–æ–≤–∞—Ä –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? üõçÔ∏è',
 *     options: ['üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω—ã', 'üëï –û–¥–µ–∂–¥–∞', 'üìö –ö–Ω–∏–≥–∏']
 * };
 * ```
 */
export interface ITelegramCard {
    /**
     * –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –æ–ø—Ä–æ—Å–∞.
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–ø—Ä–æ—Å–∞.
     *
     * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
     * - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç–º–æ–¥–∑–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
     * - –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –¥–ª–∏–Ω–∞: –¥–æ 300 —Å–∏–º–≤–æ–ª–æ–≤
     * - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
     *
     * @type {string}
     * @example
     * ```typescript
     * // –ü—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å
     * question: '–ö–∞–∫–æ–π —Ç–æ–≤–∞—Ä –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?'
     *
     * // –í–æ–ø—Ä–æ—Å —Å —ç–º–æ–¥–∑–∏
     * question: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞ üõçÔ∏è'
     *
     * // –í–æ–ø—Ä–æ—Å —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
     * question: '–ö–∞–∫–æ–π —Ç–æ–≤–∞—Ä –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ:'
     * ```
     */
    question: string;

    /**
     * –ú–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–æ—Å–∞.
     * –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞.
     *
     * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
     * - –ú–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
     * - –ú–∞–∫—Å–∏–º—É–º 10 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞
     * - –ö–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤
     * - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç–º–æ–¥–∑–∏
     *
     * @type {string[]}
     * @example
     * ```typescript
     * // –ü—Ä–æ—Å—Ç—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
     * options: ['–î–∞', '–ù–µ—Ç', '–ù–µ –∑–Ω–∞—é']
     *
     * // –í–∞—Ä–∏–∞–Ω—Ç—ã —Å —ç–º–æ–¥–∑–∏
     * options: ['‚úÖ –î–∞', '‚ùå –ù–µ—Ç', '‚ùì –ù–µ –∑–Ω–∞—é']
     *
     * // –í–∞—Ä–∏–∞–Ω—Ç—ã —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
     * options: [
     *     '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ (—Å–º–∞—Ä—Ç—Ñ–æ–Ω—ã, –Ω–æ—É—Ç–±—É–∫–∏)',
     *     '–û–¥–µ–∂–¥–∞ (–º—É–∂—Å–∫–∞—è, –∂–µ–Ω—Å–∫–∞—è)',
     *     '–ö–Ω–∏–≥–∏ (—Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ, —É—á–µ–±–Ω—ã–µ)'
     * ]
     * ```
     */
    options: string[];
}

/**
 * @class TelegramCard
 * –ö–ª–∞—Å—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ.
 * –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç TemplateCardTypes –∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –¥–ª—è –¢–µ–ª–µ–≥—Ä–∞–º–∞ –ª–æ–≥–∏–∫—É.
 *
 * –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
 * - –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–æ–≤ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤
 * - –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –ø–æ–¥–ø–∏—Å—è–º–∏
 * - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
 * - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
 * - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
 * - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
 *
 * @example
 * ```typescript
 * // –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
 * const card = new TelegramCard();
 * card.title = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
 * card.images = [
 *     new Image('electronics.jpg', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', '–û–ø–∏—Å–∞–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏'),
 *     new Image('clothes.jpg', '–û–¥–µ–∂–¥–∞', '–û–ø–∏—Å–∞–Ω–∏–µ –æ–¥–µ–∂–¥—ã')
 * ];
 * const result = await card.getCard(false);
 *
 * // –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞ —Å —ç–º–æ–¥–∑–∏
 * const cardWithEmoji = new TelegramCard();
 * cardWithEmoji.title = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä üõçÔ∏è';
 * cardWithEmoji.images = [
 *     new Image('phone.jpg', 'üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω—ã', '–ù–æ–≤–µ–π—à–∏–µ –º–æ–¥–µ–ª–∏'),
 *     new Image('laptop.jpg', 'üíª –ù–æ—É—Ç–±—É–∫–∏', '–ú–æ—â–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞')
 * ];
 * const resultWithEmoji = await cardWithEmoji.getCard(false);
 * ```
 */
export class TelegramCard extends TemplateCardTypes {
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ.
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç –æ–ø—Ä–æ—Å–∞.
     *
     * –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã:
     * 1. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:
     *    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
     *    - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ—Ç –µ–≥–æ
     *    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —á–∞—Ç
     * 2. –°–æ–±–∏—Ä–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:
     *    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–∞–∫ –≤–∞—Ä–∏–∞–Ω—Ç—ã
     *    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–º–∏–Ω–∏–º—É–º 2)
     * 3. –°–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç –æ–ø—Ä–æ—Å–∞:
     *    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç title –∫–∞–∫ –≤–æ–ø—Ä–æ—Å
     *    - –î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
     * 4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏:
     *    - –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ –≤ —Ñ–∞–π–ª
     *    - –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
     *
     * @param {boolean} _ - –§–ª–∞–≥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
     * @returns {Promise<ITelegramCard | null>} –û–±—ä–µ–∫—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
     * @throws {Error} –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
     *
     * @example
     * ```typescript
     * const card = new TelegramCard();
     * card.title = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä';
     * card.images = [
     *     new Image('product1.jpg', '–¢–æ–≤–∞—Ä 1', '–û–ø–∏—Å–∞–Ω–∏–µ 1'),
     *     new Image('product2.jpg', '–¢–æ–≤–∞—Ä 2', '–û–ø–∏—Å–∞–Ω–∏–µ 2')
     * ];
     *
     * // –ü–æ–ª—É—á–∏—Ç—å –æ–ø—Ä–æ—Å
     * const result = await card.getCard(false);
     * // result = {
     * //     question: '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä',
     * //     options: ['–¢–æ–≤–∞—Ä 1', '–¢–æ–≤–∞—Ä 2']
     * // }
     *
     * // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
     * try {
     *     const result = await card.getCard(false);
     *     if (result) {
     *         // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
     *     } else {
     *         // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
     *     }
     * } catch (error) {
     *     // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
     *     console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–ø—Ä–æ—Å–∞:', error);
     * }
     * ```
     */
    public async getCard(_: boolean): Promise<ITelegramCard | null> {
        let object: ITelegramCard | null = null;
        const options: string[] = [];
        for (let i = 0; i < this.images.length; i++) {
            const image = this.images[i];
            try {
                if (!image.imageToken) {
                    if (image.imageDir) {
                        const mImage = new ImageTokens(this._appContext);
                        mImage.type = ImageTokens.T_TELEGRAM;
                        mImage.caption = image.desc;
                        mImage.path = image.imageDir;
                        image.imageToken = await mImage.getToken();
                    }
                } else {
                    await new TelegramRequest(this._appContext).sendPhoto(
                        this._appContext.platformParams.user_id as TTelegramChatId,
                        image.imageToken,
                        image.desc,
                    );
                }
                options.push(image.title);
            } catch (e) {
                // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ü–∏–∫–ª
                const error = `\n${Date} –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è Telegram: ${e}`;
                this._appContext.saveLog('TelegramCard.log', error);
            }
        }
        if (options.length > 1) {
            object = {
                question: this.title || '',
                options: options,
            };
        }
        return object;
    }
}
